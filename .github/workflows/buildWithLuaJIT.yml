name: Build with LuaJIT + Latest LuaBridge (Fix Headers)

on:
  push:
    branches: [ "master", "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout Plugin Source
      uses: actions/checkout@v3
      with:
        path: repo

    - name: Checkout LuaJIT
      uses: actions/checkout@v3
      with:
        repository: LuaJIT/LuaJIT
        path: luajit
        ref: v2.1

    - name: Checkout Latest LuaBridge
      uses: actions/checkout@v3
      with:
        repository: vinniefalco/LuaBridge
        path: luabridge

    - name: Add MSBuild to PATH
      uses: microsoft/setup-msbuild@v1.1

    - name: Compile LuaJIT (Static)
      shell: cmd
      run: |
        cd luajit\src
        msvcbuild.bat static
        copy lua51.lib luajit.lib
        dir *.lib

    - name: Patch Project and Fix Headers
      shell: powershell
      run: |
        $root = "$pwd\repo"
        $projDir = "$root"
        $vcxproj = "$projDir\TrafficMonitorLuaPlugin.vcxproj"
        $cppFile = "$projDir\TrafficMonitorLuaPlugin.cpp"
        $luajitSrc = "$pwd\luajit\src"
        $luabridgeInclude = "$pwd\luabridge\Source" 

        # --- 关键修正：生成正确的 lua.hpp ---
        # 必须同时包含 lua.h, lualib.h, lauxlib.h，并使用 extern "C" 避免名称修饰问题
        $luaHppContent = @"
        // Auto-generated lua.hpp for LuaJIT static link
        #pragma once
        extern "C" {
        #include "lua.h"
        #include "lualib.h"
        #include "lauxlib.h"
        }
        "@
        Set-Content -Path "$luajitSrc\lua.hpp" -Value $luaHppContent
        Write-Host ">>> lua.hpp created successfully."

        # --- 修改 .vcxproj ---
        Write-Host ">>> Reading .vcxproj..."
        $xml = Get-Content $vcxproj -Raw

        # 1. 强制升级到 C++17 (LuaBridge 3 需要)
        if ($xml -match '<LanguageStandard>') {
            $xml = $xml -replace '<LanguageStandard>.*?</LanguageStandard>', '<LanguageStandard>stdcpp17</LanguageStandard>'
        } else {
            $xml = $xml -replace '<ClCompile>', "<ClCompile>`r`n      <LanguageStandard>stdcpp17</LanguageStandard>"
        }
        # 关闭严格模式，防止 C++17 下 Windows SDK 报错
        $xml = $xml -replace '<ConformanceMode>true</ConformanceMode>', '<ConformanceMode>false</ConformanceMode>'

        # 2. 修正 Include 路径 (指向 LuaJIT 和 LuaBridge/Source)
        $newIncludePath = "<IncludePath>$luajitSrc;$luabridgeInclude;`$(ProjectDir);`$(IncludePath)</IncludePath>"
        $xml = [regex]::Replace($xml, '<IncludePath>.*?</IncludePath>', $newIncludePath)

        # 3. 修正 Lib 路径
        $newLibDir = "<AdditionalLibraryDirectories>$luajitSrc;%(AdditionalLibraryDirectories)</AdditionalLibraryDirectories>"
        $xml = [regex]::Replace($xml, '<AdditionalLibraryDirectories>.*?</AdditionalLibraryDirectories>', $newLibDir)

        # 4. 替换依赖库文件名
        $xml = $xml -replace 'lua54.lib', 'lua51.lib'

        # 5. 添加静态库宏 (LUA_LIB) 并移除可能导致冲突的宏
        $xml = $xml -replace '<PreprocessorDefinitions>', '<PreprocessorDefinitions>LUA_LIB;'

        Set-Content -Path $vcxproj -Value $xml
        Write-Host ">>> .vcxproj Patched."

        # --- 修改 C++ 源码以适配 LuaJIT (Lua 5.1) ---
        Write-Host ">>> Patching C++ Source..."
        $cppContent = Get-Content $cppFile -Raw

        # 移除 Lua 5.2+ 的 checkversion
        $cppContent = $cppContent -replace 'luaL_checkversion\(L\);', '// luaL_checkversion(L);'

        # 替换 luaL_newlib 为 luaL_register (兼容 LuaJIT)
        $pattern = 'luaL_newlib\s*\(\s*L\s*,\s*([a-zA-Z0-9_]+)\s*\);'
        $cppContent = [regex]::Replace($cppContent, $pattern, {
            param($match)
            return "lua_newtable(L);`r`n    luaL_register(L, NULL, $($match.Groups[1].Value));"
        })
        
        # 兼容性修复：如果在 LuaScriptManager.cpp 中也使用了 luaL_newlib 或 openlibs
        # 有时 TrafficMonitor 插件结构不同，可能需要检查其他文件
        # 这里假设主要逻辑在 TrafficMonitorLuaPlugin.cpp 或 LuaScriptManager.cpp
        # 我们简单遍历一下所有 cpp 文件做替换
        Get-ChildItem -Path $projDir -Filter "*.cpp" | ForEach-Object {
            $code = Get-Content $_.FullName -Raw
            $newCode = $code -replace 'luaL_checkversion\(L\);', '// luaL_checkversion(L);'
            $newCode = [regex]::Replace($newCode, $pattern, {
                param($match)
                return "lua_newtable(L);`r`n    luaL_register(L, NULL, $($match.Groups[1].Value));"
            })
            # 解决 LuaScriptManager 中可能的 includes 问题，确保它能找到 lua.hpp
            if ($newCode -match '#include "lua.hpp"') {
                 # 没问题，已经有了
            }
            Set-Content -Path $_.FullName -Value $newCode
        }

        Set-Content -Path $cppFile -Value $cppContent # 再次保存主文件以防覆盖
        Write-Host ">>> Source Code Patched."

    - name: Build Solution
      run: |
        msbuild repo\TrafficMonitorLuaPlugin.sln /p:Configuration=Release /p:Platform=x64

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: TrafficMonitorLuaPlugin_Fixed
        path: repo\x64\Release\plugins\TrafficMonitorLuaPlugin.dll
